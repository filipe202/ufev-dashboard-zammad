<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Zammad – Tickets resolvidos por agente/dia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
        margin: 20px;
        line-height: 1.35;
      }
      header {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
        margin-bottom: 12px;
      }
      label {
        font-size: 12px;
        color: #555;
        display: block;
        margin-bottom: 4px;
      }
      input,
      button {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      input {
        min-width: 260px;
      }
      .sep {
        height: 1px;
        background: #eee;
        margin: 14px 0;
      }
      .status {
        font-size: 12px;
        color: #666;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
        font-size: 14px;
      }
      th,
      td {
        border: 1px solid #eee;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #fafafa;
      }
      #chart {
        max-width: 100%;
        height: 380px;
      }
      .hint {
        font-size: 12px;
        color: #888;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>Dashboard – Tickets resolvidos por agente/dia</h1>

      <header>
        <div>
          <label for="baseUrl">Base URL do Zammad</label>
          <input
            id="baseUrl"
            v-model="baseUrl"
            placeholder="https://ufevsuporte.zammad.com"
          />
        </div>
        <div>
          <label for="token">Token (Authorization)</label>
          <input id="token" v-model="token" placeholder="Token pessoal/API" />
          <div class="hint">O token é mantido apenas nesta página.</div>
        </div>
        <div>
          <label for="from">De (YYYY-MM-DD)</label>
          <input id="from" v-model="from" />
        </div>
        <div>
          <label for="to">Até (YYYY-MM-DD, opcional)</label>
          <input id="to" v-model="to" />
        </div>
        <div>
          <button @click="run">Atualizar</button>
        </div>
      </header>

      <div class="status">{{ status }}</div>
      <div class="sep"></div>

      <canvas id="chart" ref="chartCanvas"></canvas>

      <div class="sep"></div>

      <div v-if="days.length">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th v-for="agent in agents" :key="agent">{{ agent }}</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="day in days" :key="day">
              <td>{{ day }}</td>
              <td v-for="agent in agents" :key="agent + day">
                {{ cellValue(day, agent) }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Chart.js CDN (versão explícita para evitar 404 de source map) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            baseUrl: "https://ufevsuporte.zammad.com",
            token: "",
            from: "",
            to: "",
            status: "Pronto.",
            days: [],
            agents: [],
            counts: {},
            chart: null,
          };
        },
        mounted() {
          this.setDefaultDates();
        },
        methods: {
          setDefaultDates() {
            const to = new Date();
            const from = new Date(to.getTime() - 29 * 24 * 3600 * 1000);
            const fmt = (d) => d.toISOString().slice(0, 10);
            this.from = fmt(from);
            this.to = fmt(to);
          },
          setStatus(msg) {
            this.status = msg;
          },
          cellValue(day, agent) {
            return (this.counts[day] && this.counts[day][agent]) || 0;
          },
          requestInit(token) {
            return {
              headers: { Authorization: `Token token=${token}` },
              mode: "cors",
            };
          },
          isoDay(zIso) {
            const d = new Date(zIso);
            return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())
              .toISOString()
              .slice(0, 10);
          },
          async pagedGet(url, token) {
            let page = 1;
            let out = [];
            while (true) {
              const u = new URL(url);
              u.searchParams.set("per_page", 200);
              u.searchParams.set("page", page);
              const res = await fetch(u, this.requestInit(token));
              if (!res.ok) throw new Error(`HTTP ${res.status} em ${u}`);
              const data = await res.json();
              if (!Array.isArray(data) || data.length === 0) break;
              out = out.concat(data);
              if (data.length < 200) break;
              page++;
            }
            return out;
          },
          async searchTickets(url, token, query) {
            let page = 1;
            let out = [];
            while (true) {
              const u = new URL(url);
              u.searchParams.set("query", query);
              u.searchParams.set("expand", "true");
              u.searchParams.set("per_page", 200);
              u.searchParams.set("page", page);
              const res = await fetch(u, this.requestInit(token));
              if (!res.ok) throw new Error(`HTTP ${res.status} em ${u}`);
              const data = await res.json();
              if (!Array.isArray(data) || data.length === 0) break;
              out = out.concat(data);
              if (data.length < 200) break;
              page++;
            }
            return out;
          },
          async run() {
            try {
              this.setStatus("A carregar utilizadores…");
              const base = this.baseUrl.trim().replace(/\/+$/, "");
              const token = this.token.trim();
              if (!base || !token) {
                alert("Indica Base URL e Token.");
                this.setStatus("Base URL e Token obrigatórios.");
                return;
              }
              const from = this.from.trim();
              if (!from) {
                alert("Indica a data inicial (from).");
                this.setStatus("Indica a data inicial.");
                return;
              }
              const to = this.to.trim();
              const dateFilter = to
                ? `close_at:>=${from} AND close_at:<=${to}`
                : `close_at:>=${from}`;
              const query = `state:closed AND ${dateFilter}`;

              const users = await this.pagedGet(`${base}/api/v1/users`, token);
              const userById = {};
              for (const u of users) {
                const name =
                  `${u.firstname || ""} ${u.lastname || ""}`.trim() ||
                  u.login ||
                  `id_${u.id}`;
                userById[u.id] = name;
              }

              this.setStatus("A carregar tickets fechados…");
              const tickets = await this.searchTickets(
                `${base}/api/v1/tickets/search`,
                token,
                query
              );

              const counts = {};
              const agentsSet = new Set();
              for (const t of tickets) {
                const ownerId = t.owner_id;
                const closed = t.close_at;
                if (!ownerId || !closed) continue;
                const day = this.isoDay(closed);
                const agent = userById[ownerId] || `id_${ownerId}`;
                counts[day] ??= {};
                counts[day][agent] = (counts[day][agent] || 0) + 1;
                agentsSet.add(agent);
              }

              this.days = Object.keys(counts).sort();
              this.agents = [...agentsSet].sort();
              this.counts = counts;

              this.renderChart();
              this.setStatus(
                `OK: ${tickets.length} tickets (fechados) no período.`
              );
            } catch (err) {
              console.error(err);
              const baseMsg = err?.message || err;
              const hint =
                err instanceof TypeError
                  ? " Possível bloqueio CORS ou problema de rede. Garante que abres o dashboard via http:// (servidor local) e que o domínio permite chamadas API a partir da tua origem."
                  : "";
              const message = `${baseMsg}${hint}`;
              this.setStatus(`Erro: ${message}`);
              alert(`Erro: ${message}`);
            }
          },
          renderChart() {
            const canvas = this.$refs.chartCanvas;
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            const datasets = this.agents.map((agent) => ({
              label: agent,
              data: this.days.map((day) => this.cellValue(day, agent)),
              borderWidth: 1,
              stack: "stack1",
            }));
            if (this.chart) {
              this.chart.destroy();
            }
            this.chart = new Chart(ctx, {
              type: "bar",
              data: { labels: this.days, datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: "top" },
                  title: { display: true, text: "Tickets fechados por dia" },
                },
                scales: {
                  x: { stacked: true },
                  y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { precision: 0 },
                  },
                },
              },
            });
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
